<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        button { padding: 10px; margin: 5px; background: #8b5cf6; color: white; border: none; cursor: pointer; }
        button:hover { background: #7c3aed; }
        #output { background: #2a2a2a; padding: 20px; margin-top: 20px; border-radius: 5px; white-space: pre-wrap; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
    </style>
</head>
<body>
    <h1>Authentication Debug Test</h1>
    
    <div>
        <button onclick="testLogin()">1. Test Login</button>
        <button onclick="checkAuth()">2. Check Auth</button>
        <button onclick="checkCookies()">3. Check Cookies</button>
        <button onclick="testLogout()">4. Test Logout</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
    
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        async function testLogin() {
            log('Testing login...', 'info');
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: 'testuser',
                        password: 'testpass123'
                    })
                });
                
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                // Check response headers
                const setCookie = response.headers.get('set-cookie');
                log(`Set-Cookie header: ${setCookie || 'None'}`, setCookie ? 'success' : 'error');
                
                const data = await response.json();
                log(`Response: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('Login successful! Now check auth status.', 'success');
                    setTimeout(checkAuth, 500);
                }
            } catch (err) {
                log(`Error: ${err.message}`, 'error');
            }
        }
        
        async function checkAuth() {
            log('Checking authentication status...', 'info');
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log(`Auth status: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                
                if (data.ok && data.user) {
                    log(`Authenticated as: ${data.user.username}`, 'success');
                } else {
                    log('Not authenticated', 'error');
                }
            } catch (err) {
                log(`Error: ${err.message}`, 'error');
            }
        }
        
        function checkCookies() {
            log('Checking cookies...', 'info');
            const cookies = document.cookie;
            if (cookies) {
                log(`Current cookies: ${cookies}`, 'info');
                // Parse and display individual cookies
                cookies.split(';').forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    log(`  ${name}: ${value ? value.substring(0, 50) + '...' : 'empty'}`, 'info');
                });
            } else {
                log('No cookies found in document.cookie', 'error');
                log('Note: HttpOnly cookies won\'t appear here but still work for requests', 'info');
            }
        }
        
        async function testLogout() {
            log('Testing logout...', 'info');
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log(`Response: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('Logout successful! Checking auth status...', 'success');
                    setTimeout(checkAuth, 500);
                }
            } catch (err) {
                log(`Error: ${err.message}`, 'error');
            }
        }
        
        // Check initial state
        log('Page loaded. Click "Test Login" to begin.', 'info');
        checkCookies();
    </script>
</body>
</html>