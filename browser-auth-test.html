<!DOCTYPE html>
<html>
<head>
    <title>Browser Auth Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { padding: 10px; margin: 5px; background: #333; color: #0f0; border: 1px solid #0f0; cursor: pointer; }
        button:hover { background: #444; }
        .result { margin: 10px 0; padding: 10px; background: #222; border: 1px solid #444; }
        .success { border-color: #0f0; }
        .error { border-color: #f00; color: #f00; }
    </style>
</head>
<body>
    <h2>Browser Authentication Test</h2>
    
    <div>
        <button onclick="testRegister()">1. Register New User</button>
        <button onclick="testLogin()">2. Login</button>
        <button onclick="testAuth()">3. Check Auth</button>
        <button onclick="clearCookies()">Clear Cookies</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const testUser = 'browser_test_' + Date.now();
        const password = 'password123';
        
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = 'result ' + (isError ? 'error' : 'success');
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('results').prepend(div);
        }
        
        async function testRegister() {
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: testUser,
                        displayName: 'Browser Test',
                        password: password,
                        confirmPassword: password,
                        email: testUser + '@test.com',
                        lawSchool: 'Test Law'
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    log(`✓ Registered: ${testUser}`);
                    log('Cookies after register: ' + document.cookie);
                } else {
                    log('✗ Registration failed: ' + JSON.stringify(data), true);
                }
            } catch (e) {
                log('✗ Register error: ' + e.message, true);
            }
        }
        
        async function testLogin() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: testUser,
                        password: password
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    log(`✓ Logged in: ${data.user.username}`);
                    log('Cookies after login: ' + document.cookie);
                } else {
                    log('✗ Login failed: ' + JSON.stringify(data), true);
                }
            } catch (e) {
                log('✗ Login error: ' + e.message, true);
            }
        }
        
        async function testAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.ok) {
                    log(`✓ Authenticated as: ${data.user.username}`);
                    log('Session cookies: ' + document.cookie);
                } else {
                    log('✗ Not authenticated', true);
                    log('Current cookies: ' + document.cookie);
                }
            } catch (e) {
                log('✗ Auth check error: ' + e.message, true);
            }
        }
        
        function clearCookies() {
            document.cookie.split(";").forEach(c => {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            log('Cleared all cookies');
        }
        
        log('Test credentials: ' + testUser + ' / ' + password);
        log('Click buttons in order: Register → Login → Check Auth');
    </script>
</body>
</html>