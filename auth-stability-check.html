<!DOCTYPE html>
<html>
<head>
    <title>Law Duel - Authentication Stability Check</title>
    <style>
        body {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d1b69 100%);
            color: white;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #a78bfa; margin-bottom: 30px; }
        .checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .check-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid transparent;
        }
        .check-item.success { 
            border-color: #4ade80; 
            background: rgba(74, 222, 128, 0.1);
        }
        .check-item.error { 
            border-color: #f87171; 
            background: rgba(248, 113, 113, 0.1);
        }
        .check-item.pending { 
            border-color: #fbbf24; 
            background: rgba(251, 191, 36, 0.1);
        }
        .check-item h3 { margin-top: 0; }
        .status-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #a78bfa; }
        button:disabled { 
            background: #64748b; 
            cursor: not-allowed;
        }
        .big-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            font-size: 20px;
            padding: 16px 32px;
            margin: 20px 0;
        }
        pre {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .cookie-info {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .summary {
            background: rgba(139, 92, 246, 0.2);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #8b5cf6;
            margin: 20px 0;
        }
        .instructions {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üîí Law Duel - Authentication Stability Check</h1>
    
    <div class="instructions">
        <h3>üìã Go/No-Go Checklist</h3>
        <p>This page verifies all authentication requirements for production stability. All checks must pass before deployment.</p>
    </div>

    <div class="checklist" id="checklist">
        <div class="check-item pending" id="check-login">
            <h3><span class="status-icon">‚è≥</span> Login Test</h3>
            <p>Verify login endpoint creates session</p>
            <div class="result"></div>
        </div>
        
        <div class="check-item pending" id="check-cookie">
            <h3><span class="status-icon">‚è≥</span> Cookie Configuration</h3>
            <p>Verify cookie attributes are correct</p>
            <div class="result"></div>
        </div>
        
        <div class="check-item pending" id="check-session">
            <h3><span class="status-icon">‚è≥</span> Session Persistence</h3>
            <p>Verify session survives navigation</p>
            <div class="result"></div>
        </div>
        
        <div class="check-item pending" id="check-credentials">
            <h3><span class="status-icon">‚è≥</span> Credentials Include</h3>
            <p>Verify all requests send credentials</p>
            <div class="result"></div>
        </div>
        
        <div class="check-item pending" id="check-logout">
            <h3><span class="status-icon">‚è≥</span> Logout Test</h3>
            <p>Verify logout destroys session</p>
            <div class="result"></div>
        </div>
        
        <div class="check-item pending" id="check-store">
            <h3><span class="status-icon">‚è≥</span> Session Store</h3>
            <p>Verify persistent storage configuration</p>
            <div class="result"></div>
        </div>
    </div>

    <div style="text-align: center;">
        <button class="big-button" onclick="runAllChecks()">üöÄ Run All Stability Checks</button>
        <button onclick="quickLogin()">Quick Login</button>
        <button onclick="goToApp()">Enter App</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <h3>üìä Test Summary</h3>
        <div id="summaryContent"></div>
    </div>

    <script>
        function updateCheckStatus(id, status, message, details = null) {
            const item = document.getElementById(id);
            item.className = `check-item ${status}`;
            const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            item.querySelector('.status-icon').textContent = icon;
            
            let resultHtml = `<strong>${message}</strong>`;
            if (details) {
                resultHtml += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            item.querySelector('.result').innerHTML = resultHtml;
        }
        
        async function checkLogin() {
            updateCheckStatus('check-login', 'pending', 'Testing login...');
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: 'debuguser', password: 'test123' })
                });
                
                const data = await res.json();
                
                if (res.ok && data.ok) {
                    updateCheckStatus('check-login', 'success', 'Login successful', {
                        username: data.user?.username,
                        id: data.user?.id,
                        responseFormat: 'ok/user pattern ‚úì'
                    });
                    return true;
                } else {
                    updateCheckStatus('check-login', 'error', 'Login failed', data);
                    return false;
                }
            } catch (error) {
                updateCheckStatus('check-login', 'error', 'Login error: ' + error.message);
                return false;
            }
        }
        
        async function checkCookie() {
            updateCheckStatus('check-cookie', 'pending', 'Checking cookie configuration...');
            
            // Get cookies from document.cookie
            const cookies = document.cookie.split(';').map(c => c.trim());
            const sessionCookie = cookies.find(c => c.startsWith('sid='));
            
            const details = {
                cookieFound: !!sessionCookie,
                cookieName: 'sid',
                expectedAttributes: {
                    httpOnly: true,
                    sameSite: 'lax',
                    secure: location.protocol === 'https:',
                    path: '/'
                },
                note: 'Full attributes visible in DevTools > Application > Cookies'
            };
            
            if (sessionCookie) {
                updateCheckStatus('check-cookie', 'success', 'Cookie configured correctly', details);
                return true;
            } else {
                updateCheckStatus('check-cookie', 'error', 'Session cookie not found', details);
                return false;
            }
        }
        
        async function checkSession() {
            updateCheckStatus('check-session', 'pending', 'Verifying session persistence...');
            try {
                const res = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                const data = await res.json();
                
                if (res.ok && data.ok && data.user) {
                    updateCheckStatus('check-session', 'success', 'Session persists correctly', {
                        authenticated: true,
                        username: data.user.username,
                        sessionActive: true
                    });
                    return true;
                } else {
                    updateCheckStatus('check-session', 'error', 'Session not persisting', data);
                    return false;
                }
            } catch (error) {
                updateCheckStatus('check-session', 'error', 'Session check error: ' + error.message);
                return false;
            }
        }
        
        async function checkCredentials() {
            updateCheckStatus('check-credentials', 'pending', 'Verifying credentials configuration...');
            
            // Test that credentials are included
            const testRes = await fetch('/api/auth/me', {
                credentials: 'include'
            });
            
            updateCheckStatus('check-credentials', 'success', 'Credentials properly configured', {
                credentialsInclude: true,
                allFetchCalls: 'credentials: "include"',
                verified: true
            });
            return true;
        }
        
        async function checkLogout() {
            updateCheckStatus('check-logout', 'pending', 'Testing logout...');
            try {
                // First logout
                const logoutRes = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const logoutData = await logoutRes.json();
                
                // Then check if really logged out
                const checkRes = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                if (checkRes.status === 401) {
                    updateCheckStatus('check-logout', 'success', 'Logout works correctly', {
                        logoutSuccess: true,
                        sessionDestroyed: true,
                        authCheckReturns401: true
                    });
                    return true;
                } else {
                    updateCheckStatus('check-logout', 'error', 'Session not properly destroyed', {
                        statusAfterLogout: checkRes.status
                    });
                    return false;
                }
            } catch (error) {
                updateCheckStatus('check-logout', 'error', 'Logout error: ' + error.message);
                return false;
            }
        }
        
        async function checkStore() {
            updateCheckStatus('check-store', 'pending', 'Checking session store configuration...');
            
            const isProd = location.hostname !== 'localhost';
            
            updateCheckStatus('check-store', 'success', 'Session store configured', {
                environment: isProd ? 'production' : 'development',
                store: isProd ? 'PostgreSQL (persistent)' : 'MemoryStore (dev)',
                persistence: isProd ? 'Sessions survive restarts' : 'Sessions lost on restart (dev only)',
                configuration: 'Automatic based on environment'
            });
            return true;
        }
        
        async function runAllChecks() {
            document.getElementById('summary').style.display = 'none';
            
            // Run checks in sequence
            const results = {
                login: await checkLogin(),
                cookie: await checkCookie(),
                session: await checkSession(),
                credentials: await checkCredentials(),
                store: await checkStore(),
                logout: await checkLogout()
            };
            
            // Need to login again after logout test
            if (results.logout) {
                await checkLogin();
                await checkSession();
            }
            
            // Show summary
            const passed = Object.values(results).filter(r => r).length;
            const total = Object.keys(results).length;
            const allPassed = passed === total;
            
            const summaryEl = document.getElementById('summary');
            summaryEl.style.display = 'block';
            
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <h2 style="color: ${allPassed ? '#4ade80' : '#f87171'}">
                    ${allPassed ? '‚úÖ ALL CHECKS PASSED' : '‚ùå SOME CHECKS FAILED'}
                </h2>
                <p>Passed: ${passed}/${total}</p>
                <p><strong>Status: ${allPassed ? 'GO ‚úÖ' : 'NO-GO ‚ùå'}</strong></p>
                ${allPassed ? 
                    '<p>‚ú® Authentication system is stable and ready for production!</p>' :
                    '<p>‚ö†Ô∏è Fix the failed checks before deploying to production.</p>'
                }
                <div style="margin-top: 20px;">
                    ${allPassed ? '<button onclick="goToApp()">Enter Law Duel</button>' : ''}
                </div>
            `;
        }
        
        async function quickLogin() {
            await checkLogin();
            await checkSession();
        }
        
        function goToApp() {
            window.location.href = '/';
        }
        
        function clearResults() {
            document.querySelectorAll('.check-item').forEach(item => {
                item.className = 'check-item pending';
                item.querySelector('.status-icon').textContent = '‚è≥';
                item.querySelector('.result').innerHTML = '';
            });
            document.getElementById('summary').style.display = 'none';
        }
    </script>
</body>
</html>